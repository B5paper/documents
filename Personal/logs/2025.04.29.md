* ai 的回答不可能替代人的理解

    猜想：人的理解的本质是将新知识的每一个概念节点与脑中已有的旧知识的大量概念节点进行匹配，最终可以对某个现象做出解释，预测，并且有能力验证。新概念的融入要求不能对既有的知识体系引入矛盾。由于这个过程一定是需要人亲自完成的，所以 ai 并不能缩短这一过程的时间。ai 可以提供信息源，可以提高匹配过程的效率，但是无法真正地取代匹配。因此 ai 的回答不可能替代人的理解。

* dkms example

    创建工程文件夹：`dkms_test`

    加入文件：

    * `dkms_test.c`:

        ```c
        #include <linux/init.h>
        #include <linux/module.h>

        int init_mod(void);
        void exit_mod(void);

        int init_mod(void) {
            printk(KERN_INFO "init hlc mod\n");
            return 0;
        }

        void exit_mod() {
            printk(KERN_INFO "exit hlc mod\n");
        }

        module_init(init_mod);
        module_exit(exit_mod);
        MODULE_LICENSE("GPL");
        ```

    * `Makefile`:

        ```makefile
        kern_dir := /usr/src/linux-headers-6.8.0-58-generic
        obj-m += dkms_test.o

        default:
        	make -C $(kern_dir) M=$(PWD) modules

        clean:
        	rm -f *.ko *.o *.mod *.mod.c *.cmd *.order *.symvers .*.cmd
        ```

    * `dkms.conf`:

        ```conf
        PACKAGE_NAME="dkms_test"
        PACKAGE_VERSION="1.0"
        BUILT_MODULE_NAME[0]="dkms_test"
        DEST_MODULE_LOCATION[0]="/kernel/extra"
        AUTOINSTALL="yes"
        ```

    回退到上一级文件夹，然后将`dkms_test`文件夹复制到`/usr/src`下：

    `sudo cp -r dkms_test /usr/src/dkms_test-1.0`

    向 dkms 数据库中添加新项目：

    `sudo dkms add -m dkms_test -v 1.0`

    output:

    ```
    Creating symlink /var/lib/dkms/dkms_test/1.0/source -> /usr/src/dkms_test-1.0
    ```

    如输出所示，此时`/var/lib/dkms`目录中会新建一个`dkms_test`文件夹，其目录结构如下所示：

    ```
    (base) hlc@hlc-VirtualBox:/var/lib/dkms/dkms_test$ tree .
    .
    └── 1.0
        ├── build
        └── source -> /usr/src/dkms_test-1.0

    3 directories, 0 files
    ```

    此时运行`dkms status`，输出如下：

    ```
    (base) hlc@hlc-VirtualBox:~/Documents/Projects$ dkms status 
    dkms_test/1.0: added
    ```

    执行`sudo dkms build -m dkms_test -v 1.0`进行编译，output 如下：

    ```
    (base) hlc@hlc-VirtualBox:~/Documents/Projects/dkms_test$ sudo dkms build -m dkms_test -v 1.0

    Kernel preparation unnecessary for this kernel. Skipping...

    Building module:
    cleaning build area...
    make -j4 KERNELRELEASE=6.8.0-58-generic -C /lib/modules/6.8.0-58-generic/build M=/var/lib/dkms/dkms_test/1.0/build...
    Signing module:
     - /var/lib/dkms/dkms_test/1.0/6.8.0-58-generic/x86_64/module/dkms_test.ko
    Secure Boot not enabled on this system.
    cleaning build area...
    ```

    此时可以看到 dkms 目录已经准备好了`.ko`文件：

    ```
    (base) hlc@hlc-VirtualBox:/var/lib/dkms/dkms_test/1.0/6.8.0-58-generic/x86_64$ tree .
    .
    ├── log
    │   └── make.log
    └── module
        └── dkms_test.ko

    2 directories, 2 files
    ```

    此时即可执行 install 命令：

    ```bash
    sudo dkms install -m dkms_test -v 1.0
    ```

    output:

    ```
    (base) hlc@hlc-VirtualBox:~/Documents/Projects/dkms_test$ sudo dkms install -m dkms_test -v 1.0 

    dkms_test.ko:
    Running module version sanity check.
     - Original module
       - No original module exists within this kernel
     - Installation
       - Installing to /lib/modules/6.8.0-58-generic/updates/dkms/

    depmod....
    ```

    此时可以看到`xxx.ko`已经被安装到了 kernel 目录的`updates/dkms`文件夹下：

    ```
    (base) hlc@hlc-VirtualBox:/lib/modules/6.8.0-58-generic/updates/dkms$ ls -lh dkms_test.ko 
    -rw-r--r-- 1 root root 6.2K  4月 29 17:08 dkms_test.ko
    ```

    此时的 dkms status:

    ```
    (base) hlc@hlc-VirtualBox:~$ dkms status
    dkms_test/1.0, 6.8.0-58-generic, x86_64: installed
    ```

    此时可以直接通过`modprobe`加载内核模块：

    ```
    (base) hlc@hlc-VirtualBox:~$ sudo modprobe dkms_test 
    [sudo] password for hlc: 
    (base) hlc@hlc-VirtualBox:~$ 
    ```

    dmesg output:

    ```
    [ 1243.508106] init hlc mod
    ```

    说明：

    * `dkms install`并不会执行 modprobe 或 insmod。

    * 在`dkms install`后，就可以在任意工作目录直接使用`modprobe`加载`xxxx.ko`文件了
    
        `dmesg`里仍会有这个提示：

        ```
        [  788.580510] dkms_test: loading out-of-tree module taints kernel.
        [  788.580519] dkms_test: module verification failed: signature and/or required key missing - tainting kernel
        ```

* insmod 时报错

    在`insmod`时报错`insmod: ERROR: could not insert module dkms_test.ko: Invalid module format`。
    
    经检查，`uname -r`查看的 kernel 版本与编译时 Makefile 里指定的 kernel 的版本相同，又查看`/boot`目录，`ls -lh`看到`initrd.img-xxxx`,`vmlinuz-xxxx`, `System.map-xxx`这三个文件的最后一次修改的日期都比较旧，说明最近没有被替换。

    最终发现是 gcc 的版本变了，默认版本的`gcc`在几分钟之内从`gcc-11`升级到了`gcc-12`。很有可能当前内核是`gcc-11`编译的，而编译新 ko 时，使用了`gcc-12`，导致版本不一致。

* dkms 移除 module 的 example

    与 install 相反的是 uninstall:

    ```
    (base) hlc@hlc-VirtualBox:~$ sudo dkms uninstall -m dkms_test -v 1.0
    Module dkms_test-1.0 for kernel 6.8.0-58-generic (x86_64).
    Before uninstall, this module version was ACTIVE on this kernel.

    dkms_test.ko:
     - Uninstallation
       - Deleting from: /lib/modules/6.8.0-58-generic/updates/dkms/
     - Original module
       - No original module was found for this module on this kernel.
       - Use the dkms install command to reinstall any previous module version.

    depmod...
    ```

    此时的 status 为：

    ```
    (base) hlc@hlc-VirtualBox:~$ dkms status
    dkms_test/1.0, 6.8.0-58-generic, x86_64: built
    sipu/1.0.0, 6.8.0-58-generic, x86_64: installed
    ```

    如果需要在 dkms 中移除一个 module，则可以使用`remove`:

    ```
    (base) hlc@hlc-VirtualBox:~$ sudo dkms remove -m dkms_test -v 1.0
    Module dkms_test-1.0 for kernel 6.8.0-58-generic (x86_64).
    This module version was INACTIVE for this kernel.
    depmod...
    Deleting module dkms_test-1.0 completely from the DKMS tree.
    (base) hlc@hlc-VirtualBox:~$ dkms status
    (base) hlc@hlc-VirtualBox:~$ 
    ```

    在执行`dkms remove`时，会自动执行`dkms uninstall`。

    此时`dkms_test` module 完全从`/var/lib/dkms`中被移除，但是`/usr/src/dkms_test-1.0`仍保持存在。
