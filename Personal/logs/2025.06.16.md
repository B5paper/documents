* python subprocess

    在一个进程中调用命令起另一个进程。

    example:

    ```py
    import subprocess

    def main():
        ret = subprocess.call(['ls'])
        print('ret: {}'.format(ret))
        return

    if __name__ == '__main__':
        main()
    ```

    output:

    ```
    main.py
    ret: 0
    ```

    如果需要加参数，那么可以在 list 里添加更多的元素：

    `main.py`:

    ```py
    import subprocess

    def main():
        ret = subprocess.call(['ls', '-lh'])
        print('ret: {}'.format(ret))
        return

    if __name__ == '__main__':
        main()
    ```

    run:

    `python main.py`

    output:

    ```
    total 4.0K
    -rw-rw-r-- 1 hlc hlc 155  6月 16 22:29 main.py
    ret: 0
    ```

    需要注意的是，`['my_cmd', '-my_arg val']`和`['my_cmd', '-my_arg', 'val']`在大部分情况下功能相同，但是对一小部分软件来说是有区别的，这两种形式可能只有一种可以正确执行。

* 使用`subprocess.run()`将子程序的 stdout 重定向到程序内部的内存

    example:

    ```py
    import subprocess

    def main():
        ret = subprocess.run(['ls', '-lh'], capture_output=True, text=True)
        print('stdout:')
        print('{}'.format(ret.stdout))
        print('stderr:')
        print('{}'.format(ret.stderr))
        print('ret code:')
        print('{}'.format(ret.returncode))
        return

    if __name__ == '__main__':
        main()
    ```

    output:

    ```
    stdout:
    total 4.0K
    -rw-rw-r-- 1 hlc hlc 327  6月 16 22:52 main.py

    stderr:

    ret code:
    0
    ```

    这项功能只有`subprocess.run()`可以完成，无法使用`subprocess.call()`完成。

    说明：

    1. 如果不写`text=True`，那么`ret.stdout`等保存的内容是二进制内容`b'xxxx'`，中文等字符会被编码成 utf-8 格式的三个字节，比如`\xe6\x9c\x88`。

* python 字符串的`.rindex()`, `.rfind()`是从右边开始搜索，但是返回的索引仍然是从左边开始数的。

* m3u8 中的 aes 解密

    下面是一些代码片段，无法直接运行，但是展示了解密 aes 的过程，可作为参考

    ```python
    pos = m3u8_url.find('//')
    pos = m3u8_url.find('/', pos + 2)
    main_domain = m3u8_url[:pos]  # https://www.xxx.com

    if line.startswith('#EXT-X-KEY'):
        is_ts_file_encrypted = True
        aes_iv = ''
        line_parts = line.split(',')
        for part in line_parts:
            if part.startswith('URI='):
                aes_key_url = part[5:].rstrip('\n')
                aes_key_url = aes_key_url.strip('"')
                if aes_key_url.startswith('/'):
                    aes_key_url = main_domain + aes_key_url
            if part.startswith('IV='):
                aes_iv = part[4:]
                aes_iv = aes_iv.lstrip('0x')
                aes_iv = aes_iv.rstrip('\n')
                
    aes_key_hex_cmd = ["xxd", '-p', '-c', '16', aes_key_file]
    exe_status = subprocess.run(aes_key_hex_cmd, capture_output=True, text=True)
    if exe_status.returncode != 0:
        print('fail to get aes key hex')
        return -1
    aes_key_hex = exe_status.stdout
    aes_key_hex = aes_key_hex.rstrip('\n')

    decrypt_cmd = ['openssl', 'aes-128-cbc', '-d', '-iv', aes_iv, '-K', aes_key_hex,
                   '-in', ts_file, '-out', 'tmp.ts']
    ret = subprocess.call(decrypt_cmd)
    if ret != 0:
        print('fail to decrypt, ret: {}'.format(ret))
    ```

* m3u8 format reference:

    <https://datatracker.ietf.org/doc/html/rfc8216#section-4.3.2.4>