* IB relatives

    * InfiniBand 链路层提供有序数据包传递和基于信用的流量控制

    * ref: <https://www.zhihu.com/question/422501188/answer/1488958744>

    * ib 协议栈

        * 物理层：帧。不怎么懂。

        * 链路层（data link layer）：定义数据包，主要是流控，路由选择，编码，解码

        * 网络层（network layer）：在数据包上添加一个 40 字节的全局路由报头（Global Route Header，GRH）来进行路由的选择，对数据进行转发

        * 传输层（transport layer）：主要和 queue pair (QP) 相关

    * queue pair (队列偶)

        QP 包含 send queue (SQ) 和 receive queue (RG) 两部分。

        SQ 中的每条数据被称为 send queue entry (SQE)，receive queue 中每条数据被称为 receive queue entry (RQE)。

        QP 底层由 rdma engine 负责传输数据，engine 与 engine 之间通过 fabric 相连。

    * mellanox OFED

        OFED 是 Mellanox 开发的一套协议，底层实现了 IB 协议，往上又基于 IB 协议开发了别的协议，用于和上层 app 对接，这些 app 有 MPI，NFS 等。

        OFED 由 OpenFabrics 维护。

    * IB 使用 fat tree 进行拓扑连接。但是接线的最高使用率只有一半，其他需要做冗余才能保证高性能。

    * v100 搭载的 nvlink 2 速率是 300GB/s。 pcie 3.0 速率最大是 32GB/s。

    * 常用的 IB 命令

        * `ibv_asyncwatch`：监听 IB 异步事件

        * `ibv_devices`, `ibv_devinfo`：枚举 IB 设备或设备信息

        * `ibstatus`：查询 IB 设备基本状态

        * `ibping`：验证 IB 节点之间的连通性

        * `ibtracert`：跟踪 IB 路径

        * `iblinkinfo`：查看 IB 交换模块的所有端口的连接状态。此命令会将集群内所有的 IB 交换模块都进行列举。

* OFED 相关调研

    * ofed 指的是 OpenFabrics Enterprise Distribution，这是一组 IB 的开源驱动，除了提供核心驱动，还实现了其他很多辅助功能库。

    * OFA 指的是 OpenFabrics Alliance，OFED 就是由这个组织发布的。

        这个组织就是专门研究高性能网络的。

    * QoS 指的是 Quality of Service，主要是用来保证不佳网络下的传输质量。通常用到的方法是虚拟化。

    * IB 使用 Virtual Lanes (VL) 来实现 QoS。

        虛通道是一些共享一条物理链接的相互分立的逻辑通信链路。每条链路支持最多 15 条标准虚通道和一条管理通道（VL15）。

    * ref: <https://zhuanlan.zhihu.com/p/540388721>

    * ofed 的代码主要放在

        <https://github.com/linux-rdma>

        和

        <https://git.kernel.org>

        上。

    * 在`linux-rdma` github 用户下，有

        * `rdma-core`

            主力仓库，一直都在更新。

        * `perftest`

            次主力仓库，偶尔更新。

        * `qperf`

            不知道干嘛用的，6、7年都没更新了

        * `opensm`

            三年没更新了

        * `ibsim`

            两年没更新了。

* verbs 相关知识

    IB spec defines mandatory verbs and optional verbs.

    The mandatory verbs should be implemented forcely by CI.

    verbs includes two classes: privileged verbs and user-level verbs.

    privileged users can use all verbs, and user-level users can only use user-levle verbs.

    common used verbs:

    | verbs | mandatory / optional | privilege / user-level |
    | - | - | - |
    | Open HCA | m | p |
    | Query HCA | m | p |
    | Modify HCA Attributes | m | p |
    | Close HCA | m | p |
    | Allocate Protection Domain | m | p |
    | Deallocate Protection Domain | m | p |
    | Create Address Handle | m | u |
    | Modify Address Handle | m | u |
    | Query Address Handle | m | u |
    | Destroy Address Handle | m | u |
    | Create Shared Receive Queue | SRQ | p |
    | Modify Shared Receive Queue | SRQ | p |
    | Query Shared Receive Queue | SRQ | p |
    | Destroy Sahred Receive Queue | SRQ | p |
    | Create Queue Pair | m | p |
    | Modify Queue Pair | m | p |
    | Query Queue Pair | m | p |
    | Destroy Queue Pair | m | p |
    | Get Special QP | m | p |
    | Create Completion Queue | m | p |
    | Query Completion Queue | m | p |
    | Resize Completion Queue | m | p |
    | Destroy Completion Queue | m | p |
    | Allocate L_Key | 基本内存管理扩展 | p |
    | Register Memory Region | m | p |
    | Register Physical Memory Region | m | p |
    | Query Memory Region | m | p |
    | Deregister Memory Region | m | p |
    | Reregister Memory Region | m | p |
    | Reregister Physical Memory Region | m | p |
    | Register Shared Memory Region | m | p |
    | Allocate Memory Window | m | p |
    | Query Memory Window | m | p |
    | Bind Memory Window | m | u |
    | Deallocate Memory Window | m | p |
    | Post Send Request | m | u |
    | Post Receive Request | m | u |
    | Poll for completion | m | u |
    | Request Completion Notification | m | u |
    | Set Completion Event Handler | m | p |
    | Set Asynchronous Event Handler | m | p |

    ref: <https://zhuanlan.zhihu.com/p/114943081>

    这篇知乎文章还有很长，讲得挺详细的，有时间了看看。

* vscode 可以使用`ctrl + p`搜索文件名

* mana relatives

* rdma-example relatives

    CQ 指的是 completion queue.

    SGE 不知道什么意思 

    WR 指的是 work requests

    rdma 需要用到 port

    `struct rdma_buffer_attr`

    `__attribute((packed))`表示不要让编译器尝试去 pad structure

    stag 不知道是什么意思，为什么要用 uint32_t 来表示？

    CM 指的是 connection management

    cm 与 channel, event type 相关。

    `rdma_event_channel`, `rdm_cm_event_type`, `rdma_cm_event`看起来都是内核中的类型。

    MR 指的是 memory region。

    `rdma_buffer_alloc()`看起来像是申请有权限控制的内存。这个有点像 vulkan 里的 memory object。

    pd 指的是 protection domain。

    `rdma_buffer_free()`，释放内存，不需要多说了。

    看来每一块内存都是从 protection domain 里申请的，不清楚这个 pd 是一种权限机制，还是一个内存池。

    `rdma_buffer_register()`，猜测这个函数的作用是往 pd 里添加一块大内存？

    `rdma_buffer_deregister()`，不懂，可能是 pd 里拿出一块内存？但是这个函数接受一个`ibv_mr *mr`对象，但是`ibv_mr *`类型的对象是`rdma_buffer_alloc()`返回的，说明`rdma_buffer_alloc()`一定发生在`rdma_buffer_register()`之前。这样的话，“在 pd 里申请内存”的说法就不成立。

    `process_work_completion_events()`，这个看起来像是个回调函数，用来处理事件。

    `show_rdms_cmid()`根据`rdma_cm_id *id`显示一些详细信息。

* rdma server source file note

    * `setup_client_resources()`

        预先配置好 client 的信息以及准备一个接收 client credentials 的 buffer。

        * `ibv_alloc_pd()`

        * 



