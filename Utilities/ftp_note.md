# ftp note

## cache

* ftp 主动模式与被动模式

    FTP使用两个独立的TCP连接:

    1. 控制连接 (Control Connection)

        * 端口： 服务器端始终使用 21 端口，客户端使用一个随机高位端口（如 1025+）。

        * 作用： 专门用于传输FTP命令（如 USER, PASS, LIST, RETR) 和服务器的响应码（如 200, 425）。这个连接在整个FTP会话期间一直保持打开。

    2. 数据连接 (Data Connection)

        * 端口： 端口不固定，根据模式不同而变化。

        * 作用： 专门用于实际传输文件内容或目录列表。只有在需要传输数据时才建立，传输完成后立即断开。

    主动和被动模式的区别，就在于数据连接的建立方式。

    * 主动模式（Active Mode）

        在主动模式下，数据连接由服务器端主动向客户端发起。

        工作流程：

        1. 建立控制连接：客户端随机开启一个端口（例如 N）连接服务器的21端口，建立控制通道。

        2. 客户端发送命令：客户端通过控制连接发送 PORT 命令给服务器。PORT 命令中包含了客户端用于数据连接的IP地址和一个随机开启的端口（例如 M）。命令格式类似：PORT 192,168,1,100,15,67（表示IP 192.168.1.100，端口 = 15*256 + 67 = 3907）。

        3. 服务器主动连接：服务器收到 PORT 命令后，会从自己的20端口（数据端口） 主动向客户端指定的IP和端口（客户端IP:端口M）发起TCP连接，以建立数据通道。

        4. 数据传输：数据连接建立后，开始传输文件或目录列表。

        Diagram:

        ```
        客户端 (随机端口 N)  ---控制连接---> 服务器 (端口 21)
        客户端 (随机端口 M) <---数据连接---  服务器 (端口 20)
        ```

        主要问题：

        * 客户端防火墙阻挡：客户端的防火墙看到有一个外部的IP（服务器）试图主动连接到内部的一个随机端口 M，出于安全考虑，很可能会拒绝这个连接请求，导致无法建立数据连接。错误常见为 "425 Can't open data connection"。

        * NAT（网络地址转换）问题：如果客户端在局域网内（例如使用路由器上网），其本地IP（如 192.168.1.100）是私有地址，服务器无法直接路由到该地址。PORT 命令中发送的私有IP是无效的。

        适用场景：主动模式更适用于服务器端没有防火墙限制，而客户端没有防火墙（或已正确配置）的环境。在现代网络环境下，由于客户端普遍位于防火墙或NAT之后，主动模式通常会遇到问题。

    * 被动模式（Passive Mode）

        在被动模式下，数据连接由客户端向服务器端发起。这是为了解决客户端防火墙带来的问题而设计的，也是现代FTP客户端默认的模式。

        工作流程：

        1. 建立控制连接：与主动模式相同，客户端连接服务器的21端口。

        2. 客户端发送命令：客户端通过控制连接发送 PASV 命令给服务器，请求进入被动模式。

        3. 服务器响应：服务器收到 PASV 命令后，会在自己的一端随机开启一个高位端口（例如 P），然后将这个端口号（以及自己的IP地址）通过 227 Entering Passive Mode (h1,h2,h3,h4,p1,p2) 响应返回给客户端。

        4. 客户端主动连接：客户端解析服务器返回的IP和端口，然后使用另一个随机端口向服务器的这个随机端口 P 发起TCP连接，以建立数据通道。

        5. 数据传输：数据连接建立后，开始传输。

        Diagram:

        ```
        客户端 (随机端口 N)  ---控制连接--->  服务器 (端口 21)
        客户端 (随机端口 M)  ---数据连接--->  服务器 (随机端口 P)
        ```

        主要问题：

        * 服务器端防火墙阻挡：服务器端的防火墙看到有外部连接试图连接到内部的一个随机高端口 P，可能会拒绝连接。为了解决这个问题，服务器管理员通常需要在防火墙上为FTP服务开启一个端口范围，并在FTP服务器配置中指定这个范围（如 50000-60000），然后只放行对这些端口的访问。

        适用场景：被动模式适用于客户端位于防火墙或NAT之后的绝大多数情况（如家庭、公司网络）。因为数据连接是由内向外发起的，符合防火墙的一般放行规则。

    如何选择和应用:

    * 作为FTP客户端用户：

        * 通常无需手动选择，现代FTP客户端（如FileZilla, WinSCP）默认使用被动模式（PASV），并且在绝大多数情况下都能正常工作。

        * 如果连接失败，并提示数据连接错误，可以尝试在客户端设置中切换模式。但这通常是临时的解决办法。

    * 作为FTP服务器管理员：

        * 如果服务器 behind 防火墙，为了支持被动模式，必须在防火墙设置中开放一个端口范围（如 50000-60000），并在FTP服务器软件（如 vsftpd, FileZilla Server）的配置文件中指定这个范围。

        * 例如在 vsftpd.conf 中配置：
        
            ```
            pasv_min_port=50000
            pasv_max_port=60000
            ```

    * 这样配置后，防火墙只允许外部访问服务器的21端口和50000-60000端口，既安全又能保证被动模式正常工作。

## topics